pluginManagement {
    def reactNativeGradlePlugin = new File(
            providers.exec {
                workingDir(rootDir)
                commandLine("node", "--print", "require.resolve('@react-native/gradle-plugin/package.json', { paths: [require.resolve('react-native/package.json')] })")
            }.standardOutput.asText.get().trim()
    ).getParentFile().absolutePath
    includeBuild(reactNativeGradlePlugin)

    def expoPluginsPath = new File(
            providers.exec {
                workingDir(rootDir)
                commandLine("node", "--print", "require.resolve('expo-modules-autolinking/package.json', { paths: [require.resolve('expo/package.json')] })")
            }.standardOutput.asText.get().trim(),
            "../android/expo-gradle-plugin"
    ).absolutePath
    includeBuild(expoPluginsPath)

    repositories {
        // 保留国内镜像优先级
        maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
        gradlePluginPortal()
        maven { url 'https://emas.aliyun.com/maven/repository/' }
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url 'https://maven.aliyun.com/repository/public' }
    }
}

// 核心修改1：完全删除所有settings插件（com.facebook.react.settings + expo-autolinking-settings）
// 不再声明任何老旧插件，避免触发systemProperties兼容问题
plugins {
    // 此处留空，仅保留插件声明块结构，不引入任何问题插件
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        maven { url 'https://emas.aliyun.com/maven/repository/' }
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url 'https://maven.aliyun.com/repository/public' }
        google()
        mavenCentral()
    }
}

// 核心修改2：手动配置React Native自动链接（替代com.facebook.react.settings）
extensions.findByName("react")?.with {
    if (System.getenv('EXPO_USE_COMMUNITY_AUTOLINKING') == '1') {
        autolinkLibrariesFromCommand()
    } else {
        // 手动指定Expo RN配置命令，绕过插件内部的systemProperties调用
        def rnConfigCommand = ["node", rootProject.file("node_modules/expo-modules-autolinking/scripts/rn-config.js").absolutePath]
        autolinkLibrariesFromCommand(rnConfigCommand)
    }
}

// 核心修改3：手动初始化Expo自动链接（替代expo-autolinking-settings）
def expoAutolinking = extensions.findByName("expoAutolinking")
if (expoAutolinking) {
    expoAutolinking.useExpoModules()
    expoAutolinking.useExpoVersionCatalog()
    includeBuild(expoAutolinking.reactNativeGradlePlugin)
}

// 保留项目名称和模块引用
rootProject.name = 'my-app'
include ':app'